<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>J.Player</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="http://jdoi.net/git/onee/style/initialize.css">
    <link rel="stylesheet" href="./carousel.css">
</head>
<style>
	html,body{
		height: 100%;
		width: 100%;
		font-size: 15px;
		background: #ccc url(images/bg.png) repeat;
	}
	*{
		margin: 0;
		padding: 0
	}
	em, i{
		font-style: normal;
	}
	input[type=range]{
		-webkit-appearance:none;
		background: none
	}
	input[type=range]:focus{
		outline: none;
	}
	input[type=range]::-webkit-slider-runnable-track{

	}
	input[type=range]::-moz-range-track{
		background: none;
		border:none;
	}
	input[type=range]::-webkit-slider-thumb{
		-webkit-appearance :none;
		cursor: pointer;
	}
	input[type=range]::-moz-range-thumb{
		background: none;
		cursor: pointer;
		border:none;
	}
	.ui-border-1px{
	    position: relative;
	}

	.ui-border-1px:after{
	    content: "";

	    display: block;
	    position: absolute;
	    top: 0;
	    left: 0;
	    right: -100%;
	    bottom: -100%;

	    -webkit-transform-origin: 0 0;
	    -webkit-transform: scale(0.5);

	    pointer-events: none;
	}
	.ease{
		-webkit-transition-property:all;
	    -webkit-transition-duration:.6s;
	    -webkit-transition-timing-function:ease-in-out;
		-moz-transition-property:all;
	    -moz-transition-duration:.6s;
	    -moz-transition-timing-function:ease-in-out;
	}
	.musicbox{
		/*height: 560px;*/
		width: 100%;
		height: 100%;
		/*margin: auto;*/
		color: #fff;
		position: relative;
		overflow: hidden;
	}

	.mb-article{
		position: relative;
		letter-spacing: -5px;
	}
	.mb-article:before{
		content: "";
		height: 100%;
		display: inline-block;
		vertical-align: middle;
		width: 0;
		overflow: hidden;
	}
	.mb-logo{
		position: absolute;
		font-size: 36px;
		font-weight: bold;
		height: 60px;
		line-height: 60px;
		text-align: center;
		width: 195px;
		text-shadow:0 0 5px rgba(0,0,0,.4);
		top: 12px;
		background-color: 
		left: 0
	}

	.mb-hack-vmiddle{
		position: relative;
		z-index: 1;
		display: inline-block;
		vertical-align: middle;
		width: 100%;
	}
	.mb-hack-blur{
		/*-webkit-filter: blur(5px);*/
	}
	.mb-disk,
	.mb-meter{
		position: absolute;
		height: 100%;
		width: 100%;
		top: 0;
		left: 0;
		z-index: 1
	}
	.mb-disk{
		position: relative;
		background: url(images/disk.png) center no-repeat;
		background-size: 100%;
		animation: rotate 15s linear infinite;
		-webkit-animation: rotate 15s linear infinite;
		-moz-animation: rotate 15s linear infinite;
		-ms-animation: rotate 15s linear infinite;
	}
	.mb-disk-pause{
		animation-play-state: paused;
		-webkit-animation-play-state: paused;
		-moz-animation-play-state: paused;
		-ms-animation-play-state: paused;
	}
	@-moz-keyframes rotate {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
	@-webkit-keyframes rotate {
		0% {
			-webkit-transform: rotate(0deg);
		}
		100% {
			-webkit-transform: rotate(360deg);
		}
	}
	.mb-disk-cover{
		width: 93.75%;
		height: 100%;
		position: absolute;
		/*background: url('cover.jpg') center no-repeat;*/
		background-size: cover;
		border-radius: 500px;
		top: 0;
		left: 0;
		/* top: 50%;
		left: 50%; */
		/*margin: -151px 0 0 -149px;*/
		margin:-.5% 0 0 3.7%;
		opacity: 0;
		z-index: 1
	}
	.mb-disk-cover-show{
		opacity: 1
	}
	.mb-disk-axis{
		position: absolute;
		top: 50%;
		left: 50%;
		z-index: 5;
		height: 50px;
		width: 50px;
		margin: -27px 0 0 -24px;
		background-color: #0d0f0e;
		box-shadow: inset 2px 4px 5px rgba(13,15,14,.5),
					0 0 0 25px rgba(21,24,21,.7),
					0 0 0 32px rgba(21,24,21,.4);
		border-radius: 100px;
	}

	.mb-meter{
		opacity: .4;
		z-index: 2;
	}
	.mb-music{
		position: absolute;
		z-index: 5;
		top: 0;
		left: 0;
		height: 100%;
		width: 100%;
		overflow: hidden;
	}
	.mb-music-wrap{
		height: 100%
	}
	.mb-music-item{
		width: 100%;
		height: 100%;
		/*background-color: rgba(0,0,0,.5);*/
		background: url("./images/bg.png") repeat;
		letter-spacing: 0;
		position: relative;
		-webkit-overflow-scrolling: touch;
	}
	/*.mb-music-item-bg{
		position: absolute;
		z-index: 1;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: url("./images/bg.png") repeat;
	}*/
	.mb-music-empty{
		/*background-color: transparent;*/
		background: none
	}
	.mb-music-list{
		overflow: auto;
	}
	.mb-music-list-item{
		height: 60px;
		/*line-height: 50px;*/
		margin-left: 15px;
		position: relative;
		z-index: 2;
		display: -webkit-box;
		-webkit-box-align: center;
	}
	/*.mb-music-list-item:before{
		content: "";
		width: 0;
		height: 100%;
		display: inline-block;
		vertical-align: middle;
	}*/
	.mb-music-list-item-hack-middle{
		-webkit-box-flex:10;
	}
	.mb-music-list-item:after{
		border-bottom: 1px solid #848484;
	}
	.mb-music-list-item-active{
		background-color: rgba(35,35,35,.8);
		color: #007fd5;
	}
	.mb-music-list-item-singer{
		display: block;
		font-size: 12px;
		color: #aeaeae
	}
	.mb-music-list-item-duration{
		-webkit-box-flex:1;
	}
	.mb-ctrl{
		/*border-top: 1px solid #424242;
		background: url(images/bg.png) repeat;*/
		position: absolute;
		bottom: 0;
		left: 0;
		width: 100%;
		/*padding: 0 2%;*/
		text-align: center;
		z-index: 2;
		background: rgba(0,0,0,.2)
	}
	.mb-ctrl-progress{
		position: relative;
	}
	.mb-ctrl-progress progress,
	.mb-ctrl-progress input{
		display: block;
		width: 100%;
		position: absolute;
		height: 1px;
		z-index: 1;
	}
	.mb-ctrl-progress progress{
		border: none;
		top: 0;
		left: 0
	}
	.mb-ctrl-progress input{
		position: relative;
		z-index: 2;
	}
	.mb-ctrl-progress input::-webkit-slider-thumb{
		box-shadow: 0 0 6px rgba(255,255,255,.8);
		border-radius: 4px;
		border: none;
		background-color: #016eb7;
		height: 5px;
		width: 5px;
	}

	/* .ctrl .progress input::-moz-range-thumb{
		box-shadow: 0 0 8px rgba(255,255,255,.8);
		border-radius: 4px;
		background-color: #016eb7;
		height: 4px;
		width: 4px;
	} */
	.mb-ctrl-btn{
		letter-spacing: -3px;
		margin: 8px 0;
		text-align: center;
	}
	.mb-ctrl-btns{
		background: url(images/ctrl-map.png) no-repeat;
		background-size: 100%;
		display: inline-block;
		vertical-align: middle;
	}
	.mb-ctrl-play{
		height: 70px;
		width: 70px;
		background-position: center -73px
	}
	/* .article .btn .play:hover{
		background-position: center 0
	} */
	.mb-ctrl-next{
		height: 65px;
		width: 65px;
		background-position: center -208px
	}
	/* .article .btn .next:hover{
		background-position: center -177px
	} */
	.mb-ctrl-prev{
		height: 65px;
		width: 65px;
		background-position: center -137px
	}
	.mb-currinfo{
		padding: 8px 10px;
		line-height: 18px;
		height: 40px;
		text-align: left;
	}
	.mb-currinfo-title{
		margin-bottom: 4px
	}
	.mb-currinfo-album{
		font-size: 12px
	}
	.mb-music-lyric{
		overflow: auto;
		text-align: center;
	}
	.mb-music-lyric-wrap{
		min-height: 100%;
		display: -webkit-box;
		-webkit-box-align:center;
		-webkit-box-pack:center;
		-webkit-box-orient:vertical;
		/*position: relative;*/
	}
	.mb-music-lyric-row{
		line-height: 40px;
		height: 40px;
		font-size: 16px;
		overflow: hidden;
	}
	.mb-music-lyric-row-curr{
		color: #fff;
		font-size: 20px;
		color: #ffbb39
	}
    .mb-debug{
        position: absolute;
        top: 0;
        left: 0;
        height: 20px;
        line-height: 20px;
        width: 100%;
        text-align: center;
        color: #fff;
        background-color: rgb(0,0,0)
    }
</style>
<body>
	<div class="musicbox" data-player="body">
		<!-- <h1 class="mb-logo">J.Player</h1> -->
		<!-- <a href="javascript:;" class="tiggle" mplayer="tiggle"></a> -->
		<div class="mb-article" data-player="article">
			<div class="mb-hack-vmiddle">
				<!-- 磁碟盘 -->
				<div class="mb-disk mb-disk-pause mb-hack-blur" data-player="hdisk">
					<p class="ease mb-disk-cover mb-disk-cover-show" data-player="hcover"></p>
					<p class="mb-disk-axis"></p>
				</div>
				<!-- 频谱动画 -->
				<div class="mb-meter">
					<canvas data-player="canvas"></canvas>
				</div>
			</div>
			<div class="ui-carousel mb-music" data-enable-circle-loop="false" data-enable-auto-loop="false" data-enable-dots="true">
				<div class="ui-carousel-inner mb-music-wrap">
					<!-- 列表 -->
					<div class="ui-carousel-item mb-music-item mb-music-list">
						<!-- <p class="mb-music-item-bg"></p> -->
						<ul data-player="list" class="ui-page-content"></ul>
					</div>
					<div class="ui-carousel-item mb-music-item mb-music-empty"></div>
					<!-- 歌词 -->
					<div class="ui-carousel-item mb-music-item mb-music-lyric">
						<!-- <p class="mb-music-item-bg"></p> -->
						<ul data-player="lyric" class="ease mb-music-lyric-wrap">歌词</ul>
					</div>
				</div>
			</div>
		</div>
		<!-- 控制面板 -->
		<div class="mb-ctrl" data-player="userctrl">
			<div class="mb-currinfo">
				<p class="mb-currinfo-title" data-player="name"></p>
				<p class="mb-currinfo-album" data-player="singer_album"></p>
			</div>
			<p class="mb-ctrl-progress">
				<progress max="0" value="0" mplayer="progressbg"></progress>
				<input type="range" min="0" max="0" mplayer="progress" value="0">
			</p>
			<div class="mb-ctrl-btn">
				<!-- <a href="javascript:;" class="hide-text" title="添加音乐" mplayer="add">添加音乐</a> -->
				<!-- <div class="clearfix tools">
					<a href="javascript:;" class="hide-text hmeter" title="音频图">
						音频图
						<p mplayer="hmeter"></p>
					</a><a href="javascript:;" class="hide-text heq" title="均衡器" mplayer="heqs">均衡器</a><a href="javascript:;" mplayer="playmodel" title="..." class="hide-text">...</a><a href="javascript:;" class="hide-text hlyric" mplayer="hlyric" title="歌词">歌词</a>
				</div> -->
				
				<a href="javascript:;" class="hide-text mb-ctrl-btns mb-ctrl-prev" data-player="prev" title="上一首">上一首</a>
				<a href="javascript:;" class="hide-text mb-ctrl-btns mb-ctrl-play" data-player="play" title="播放/暂停">播放/暂停</a>
				<!-- <a href="javascript:;"data-player="proxyplay"></a> -->
				<a href="javascript:;" class="hide-text mb-ctrl-btns mb-ctrl-next" data-player="next" title="下一首">下一首</a>
				<!-- <a href="javascript:;" class="hvolume">
					<input type="range" min="0" max="100" class="leve1" mplayer="volume" onwheel="1">
				</a> -->
			</div>
		</div>
		<!-- 解析音源loading -->
		<!-- <p mplayer="decoding" class="ease loading">decoding audio...</p> -->
		<!-- 均衡器控件 -->
		<!-- <div class="ease eqctrl" mplayer="eqswrap">
			<h3>equalizer</h3>
			<em class="c">X</em>
			<div class="eqlist clearfix" mplayer="eqlist"></div>
		</div> -->
		<!-- 歌词控件 -->
		<!-- <div class="ease lyric" mplayer="lyricwrap">
			<h3>lyric</h3>
			<em class="c">X</em>
			<ul mplayer="lyric" class="ease">Loading...</ul>
		</div> -->
	</div>
    <div class="mb-debug" data-player="debug"></div>
	<!-- <audio id="in2"></audio> -->
</body>
<!-- <script src="http://jdoi.net/git/onee/Lodash/lodash.min.js"></script>
<script src="http://jdoi.net/git/onee/onee.js"></script> -->
<!-- <script src="/onee/Lodash/lodash.min.js"></script>
<script src="/onee/onee.js"></script> -->
<script src="http://jdoi.net/git/onee/Lodash/lodash.min.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/zepto.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/event.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/touch.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/ajax.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/data.js"></script>
<script src="http://jdoi.net/git/onee/Tween/RequestAnimationFrame.js"></script>
<script src="./carousel.js"></script>
<script src="./index.js"></script>
<script type="text/javascript">
(function () {
	window.onerror = function (e) {
		alert(e)
	}
	/*var request = new XMLHttpRequest();
	request.open('GET', "./sources/yuwochangzai.mp3", true);
	request.responseType = 'arraybuffer';
	// Decode asynchronously
	request.onload = function() {

		console.log(request)
	}
	request.send();*/
	// onee.use("onee.mobile.mplayer", function () {

		/*var setCSS = onee.dom.css;
		var setClass = onee.dom.setClass;
		var innerHTML = onee.dom.html;
		var addClass = onee.dom.addClass;
		var removeClass = onee.dom.delClass;
		var onEvt = onee.dom.on;
		var fireEvt = onee.dom.fire;
		var innerText = onee.dom.text;
		var each = _.each;
		var map = _.map;
		var find = onee.dom.find;
		var stopDefault = onee.dom.stopDefault;
		var getAttr = onee.dom.getAttr;
		var fireEvt = onee.dom.fire;*/

		// 播放器UI层控制逻辑
		// var player = onee.mplayer;

		// init ui
		$(".ui-carousel").carousel(1);

		JPlayer.$article.css("height", window.innerHeight - JPlayer.UIuserctrl.clientHeight);
		JPlayer.$hdisk.parent().css("height", window.innerWidth * .9375);
		JPlayer.UIcanvas.height = window.innerWidth * .9375;
		JPlayer.UIcanvas.width = window.innerWidth;
		
		$('.mb-ctrl').on('touchmove', function(e){
            e.preventDefault();
        });

        // Handle the start of interactions
        $(document).on('touchstart', '.mb-music-item', function(e){
            var page = e.currentTarget;
            var startTopScroll = page.scrollTop;
            if(startTopScroll <= 0)
                page.scrollTop = 1;

            if(startTopScroll + page.offsetHeight >= page.scrollHeight)
                page.scrollTop = page.scrollHeight - page.offsetHeight - 1;

        }).on('touchmove', '.mb-music-item', function(e){
            var page = e.currentTarget;
            // TODO cache element select
            var content = page.querySelector('.ui-page-content');
            // Offset value have include content and border
            if( !content || content.offsetHeight <= parseInt(getComputedStyle(page).height) ){
                // your element have overflow
                return e.preventDefault();
            }
        })

		// alert(window.innerWidth * .9375)

		JPlayer.add([
			{ name : "与我常在", url : "./sources/yuwochangzai.mp3", singer : "陈奕迅" }
		])
		// on start a new music
		.on("start", function () {
			JPlayer.$lyric.html("").text("Loading...")
		})
		.on("playing", function () {

			JPlayer.$hdisk.removeClass("mb-disk-pause")
			// removeClass(that.ui.hdisk, "pause")

		}).on("pause", function () {

			JPlayer.$hdisk.addClass("mb-disk-pause")
			// addClass(that.ui.hdisk, "pause")

		}).on("stop", function () {

			JPlayer.$hdisk.addClass("mb-disk-pause")
			JPlayer.$hcover.removeClass("mb-disk-cover-show")
			JPlayer.$lyric.html("").text("歌词")

		});
		(function(){

			var tmpLRC;
			// 当前歌词索引
			var pointer = 1;
			var $lyric = JPlayer.$lyric;
			var middlePos = $lyric.parent().height()/2 - 20;
			// var UIlyric = JPlayer.UIlyric;
			// 歌词节点列表
			var $LRCitems;
			JPlayer.on("meta", function (e, meta) {
				var coverURL = meta.pic;
				JPlayer.$hcover
                    .css("backgroundImage", "url("+(coverURL?coverURL.slice(0, coverURL.length-6)+'.jpg':"about:blank")+")")
                    .addClass("mb-disk-cover-show");

                JPlayer.$name.text(meta.title);
                JPlayer.$singer_album.text(meta.artist+"《"+meta.album_name+"》");

                // 
                var $currPlayItem = JPlayer.$list.find("li").eq(JPlayer.current);
                $currPlayItem.find(".mb-music-list-item-singer").text(meta.artist);
                $currPlayItem.find(".mb-music-list-item-duration").text(duration2time(JPlayer.audio.duration));
				// 获取歌词文件，并解析好
				JPlayer.parseLyric(meta, function (lrcs) {
					// build lyric html
                    $lyric
                        .html($.map(lrcs, function(item) {
                            return '<li class="mb-music-lyric-row">'+item.tx+'</li>';
                        }).join(''))
                        .css({
                        	"-webkitTransform" : "translate3d(0px, "+middlePos+"px, 0px)"
                        });
                    // 引用歌词节点，初始化歌词节点
					($LRCitems = $lyric.find("li")).eq(0).addClass("mb-music-lyric-row-curr");
					// 引用到局部变量
					tmpLRC = lrcs.length && lrcs;

				});
			});
			function duration2time (duration) {
				duration = duration.toFixed(0);
				var m = Math.round(duration/60);
				var s = duration%60;
				return (m > 9 ? m : '0'+m) +':' + (s > 9 ? s : '0'+s);
			}
			JPlayer.on("timeupdate", function (e, audio) {
				if (tmpLRC) {
					// console.log(tmpLRC[pointer)
					if ( audio.currentTime > tmpLRC[pointer].s ) {
						// 移除上一行样式
                        $LRCitems.eq(pointer-1).removeClass("mb-music-lyric-row-curr");
						// removeClass(LRCitems[pointer-1], "curr")
						// 添加当前行样式
                        $LRCitems.eq(pointer).addClass("mb-music-lyric-row-curr");
						// addClass(LRCitems[pointer], "curr")
						// 设置居中
						$lyric.css({"-webkitTransform" : 'translate3d(0px, '+ (middlePos-40*pointer++) +'px, 0px)'});
						// $lyric.css("top", middlePos-40*pointer++);
                        // UIlyric.style.top = (111-40*pointer++)+'px';
						// 结束操作
						pointer === tmpLRC.length && (tmpLRC = null);
					}
				}
			});

		}());
	// });
}())
</script>
</html>