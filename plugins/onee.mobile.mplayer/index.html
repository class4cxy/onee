<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>J.Player - You can play music in that way</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="http://jdoi.net/git/onee/style/initialize.css">
    <link rel="stylesheet" href="./carousel.css">
    <link rel="stylesheet" href="./dialog.css">
    <link rel="stylesheet" href="./notify.css">
    <link rel="stylesheet" href="./alert.css">
    <link rel="stylesheet" href="./backdrop.css">
    <link rel="stylesheet" href="./index.css">
</head>
<body>
	<div class="musicbox" data-player="body">
		<!-- <h1 class="mb-logo">J.Player</h1> -->
		<!-- <a href="javascript:;" class="tiggle" mplayer="tiggle"></a> -->
		<div class="mb-article" data-player="article">
			<p class="mb-logo">J.PLAYER</p>
			<div class="mb-hack-vmiddle">
				<!-- 磁碟盘 -->
				<div class="mb-disk mb-disk-pause mb-hack-blur" data-player="hdisk">
					<p class="ease mb-disk-cover mb-disk-cover-show" data-player="hcover"></p>
					<p class="mb-disk-axis"></p>
				</div>
				<!-- 频谱动画 -->
				<div class="mb-meter">
					<canvas data-player="canvas"></canvas>
				</div>
			</div>
			<div class="ui-carousel mb-music" data-enable-circle-loop="false" data-enable-auto-loop="false" data-enable-dots="true">
				<div class="ui-carousel-inner mb-music-wrap">
					<!-- 列表 -->
					<div class="ui-carousel-item mb-music-item mb-music-list">
						<!-- <p class="mb-music-item-bg"></p> -->
						<ul data-player="list" class="ui-page-content"></ul>
					</div>
					<div class="ui-carousel-item mb-music-item mb-music-empty"></div>
					<!-- 歌词 -->
					<div class="ui-carousel-item mb-music-item mb-music-lyric">
						<!-- <p class="mb-music-item-bg"></p> -->
						<ul data-player="lyric" class="ease mb-music-lyric-wrap">歌词</ul>
					</div>
				</div>
			</div>
		</div>
		<!-- 控制面板 -->
		<div class="mb-ctrl" data-player="userctrl">
			<div class="mb-currinfo">
				<p class="mb-currinfo-title" data-player="name"></p>
				<p class="mb-currinfo-album" data-player="singer_album"></p>
			</div>
			<p class="mb-ctrl-progress">
				<progress max="100" value="" data-player="progressbg"></progress>
				<input type="range" min="0" max="100" data-player="progress" value="0">
			</p>
			<div class="mb-ctrl-btn">
				<p class="mb-ctrl-btns mb-ctrl-prev" data-player="prev">
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el1"></a>
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el2"></a>
				</p>
				<p class="ease mb-ctrl-btns mb-ctrl-play" data-player="play">
					<a class="ease mb-ctrl-btns-el mb-ctrl-btns-el1"></a>
					<a class="ease mb-ctrl-btns-el mb-ctrl-btns-el2"></a>
				</p>
				<p class="mb-ctrl-btns mb-ctrl-next" data-player="next">
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el1"></a>
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el2"></a>
				</p>
			</div>
			<div class="mb-ctrl-eq" data-player="eq">
				<p class="mb-ctrl-eq-in mb-ctrl-eq-in1"></p>
				<p class="mb-ctrl-eq-in mb-ctrl-eq-in2"></p>
				<p class="mb-ctrl-eq-in mb-ctrl-eq-in3"></p>
			</div>
			<div class="ease mb-ctrl-meter" data-player="meter">
				<p class="ease mb-ctrl-meter mb-ctrl-meter-in"></p>
			</div>
		</div>
		<!-- 解析音源loading -->
		<!-- <p mplayer="decoding" class="ease loading">decoding audio...</p> -->
	</div>
	<!-- 均衡器控件 -->
	<div id="alertEq" class="ui-dialog mb-eq" data-backdrop="close" data-effect="from-below" role="alert-dialog" data-backdrop="static">
        <div class="js-dialog-content ui-alert mb-eq-wrap">
        	<div class="mb-virtual">
        		<p class="mb-virtual-wrap">live:<input class="mb-virtual-input" data-player="convolver" type="range" min="0" max="1" value="0" step="0.01"></p>
        		<p class="mb-virtual-wrap">live:<input class="mb-virtual-input" type="range" min="0" max="1" value="0"></p>
        	</div>
            <div class="ui-alert-body mb-eq-body" role="note" id="eqScroll">
            	<div class="content mb-eq-list" data-player="eqlist"></div>
            </div>
        </div>
    </div>
	<!--notify-->
    <div id="notify" data-backdrop="false" data-expires="2000" data-effect="from-top" class="ui-dialog ui-notify" role="notify">
        <!-- <i class="icon icon-warning"></i> -->
        <span class="content"></span>
    </div>
    <!--notify-->
    <div id="alertLoader" class="ui-dialog" data-effect="from-below" role="alert-dialog" data-backdrop="static">
        <div class="js-dialog-content ui-alert mb-loader">
            <div class="ui-alert-body" role="note">
            	<div class="content">
            		<canvas class="mb-loader-cv" id="loader" height="100" width="100"></canvas>
            		<p class="mb-loader-tx" id="loaderPercent">0</p>
            	</div>
            </div>
        </div>
    </div>
</body>
<!-- <script src="http://jdoi.net/git/onee/Lodash/lodash.min.js"></script>
<script src="http://jdoi.net/git/onee/onee.js"></script> -->
<!-- <script src="/onee/Lodash/lodash.min.js"></script>
<script src="/onee/onee.js"></script> -->
<script>
	// window.onerror = function (e) {alert(JSON.stringify(arguments))}
</script>
<script src="http://jdoi.net/git/onee/Lodash/lodash.min.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/zepto.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/event.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/touch.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/ajax.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/data.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/transition.js"></script>
<script src="http://jdoi.net/git/onee/Tween/RequestAnimationFrame.js"></script>
<script src="./index.js" type="text/javascript"></script>
<script src="./carousel.js" type="text/javascript"></script>
<script src="./dialog.js" type="text/javascript"></script>
<!-- <script src="./iscroll.js" type="text/javascript"></script> -->
<script type="text/javascript">
(function () {

	var map = _.map;
	var TPL_ITEM = '<li data-player="playitem" class="ui-border-1px mb-music-list-item" data-index="{index}" data-name="{name}" data-url="{url}">\
						<div class="mb-music-list-item-hack-middle">\
						<i>{name}</i>\
						<i class="mb-music-list-item-singer"></i>\
						</div>\
						<p class="mb-music-list-item-duration"></p>\
					</li>',
		TPL_EQITEM = '<p class="mb-eq-item"><input data-freq="{freq}" class="mb-eq-input" type="range" min="-30" max="30" value="{gain}"><span>{key}</span></p>';;

	var complieHTML = (function () {
		var rtpl = /\{(.*?)\}/g;
		return function (tpl, dat, index) {
			return tpl.replace(rtpl, function (a, b) {
	    		if (b === "index") return index;
	    		return dat[b];
	    	})
		}
	}());

		// init ui
	$(".ui-carousel").carousel(1);

	JPlayer.$article.css("height", window.innerHeight - JPlayer.UIuserctrl.clientHeight);
	JPlayer.$hdisk.parent().css("height", window.innerWidth * .9375+10);
	JPlayer.UIcanvas.height = window.innerWidth * .9375+10;
	JPlayer.UIcanvas.width = window.innerWidth;
	
	$('.mb-ctrl, .js-backdrop').on('touchmove', function(e){
        e.preventDefault();
    });

    // Handle the start of interactions
    $(document).on('touchstart', '.mb-music-item', function(e){
        var page = e.currentTarget;
        var startTopScroll = page.scrollTop;
        if(startTopScroll <= 0)
            page.scrollTop = 1;

        if(startTopScroll + page.offsetHeight >= page.scrollHeight)
            page.scrollTop = page.scrollHeight - page.offsetHeight - 1;

    }).on('touchmove', '.mb-music-item', function(e){
        var page = e.currentTarget;
        // TODO cache element select
        var content = page.querySelector('.ui-page-content');
        // Offset value have include content and border
        if( !content || content.offsetHeight <= parseInt(getComputedStyle(page).height) ){
            // your element have overflow
            return e.preventDefault();
        }
    })

	// build play list
	JPlayer.$list.html(map(JPlayer.cache = [
		{ name : "福尔摩斯", url : "./sources/fuermosi.mp3", singer : "萧敬腾" },
		{ name : "与我常在", url : "./sources/yuwochangzai.mp3", singer : "陈奕迅" },
		{ name : "可以了", url : "./sources/keyile.mp3", singer : "陈奕迅" },
		{ name : "3 Things", url : "./sources/3Things.mp3", singer : "Jason Mraz" },
		{ name : "北海", url : "./sources/beihai.mp3", singer : "永动机" }
	], function (source, k) {
    	return complieHTML(TPL_ITEM, source, k)
    }).join(''));

	var uiEq = {
		"f31" : "31hz",
		"f62" : "62hz",
		"f125" : "125hz",
		"f250" : "250hz",
		"f1000" : "1khz",
		"f2000" : "2khz",
		"f4000" : "4khz",
		"f8000" : "8khz",
		"f16000" : "16khz"
	};

    JPlayer.$eqlist.html(map(JPlayer.EQ, function (eq, k) {
    	return complieHTML(TPL_EQITEM, {
    		key : uiEq[k],
    		gain : eq,
    		freq : k
    	})
    }).join('')).on("input", function (e) {
    	var element = e.target;
    	JPlayer.eq(element.dataset.freq, element.value)
    });

    JPlayer.$convolver.on("input", function (e) {
    	var element = e.target;
    	JPlayer.setConvolverGain(element.value)
    });

    // init ui meter handle
    JPlayer.meter === "wave" && JPlayer.$meter.addClass("mb-ctrl-meter-wave");

    // UI lyric
	var UImeta = (function () {

		var $lyric = JPlayer.$lyric;
		var $LRCitems;
		// 当前歌词文件，已解析
		var tmpLRC;
		// 歌词文件列表，已解析
		var cacheLRC = {};
		// 当前歌词索引
		var pointer = 1;
		// 中点坐标
		var middlePos = $lyric.parent().height()/2 - 20;

		function _initLRC (lrcs) {
			// build lyric html
            $lyric
            	// 初始化歌词列表
	            .css({
                	"-webkitTransform" : "translate3d(0px, "+middlePos+"px, 0px)"
                })
                .html($.map(lrcs, function(item) {
	                return '<li class="mb-music-lyric-row">'+item.tx+'</li>';
	            }).join(''));
            // 引用歌词节点，初始化歌词节点
			($LRCitems = $lyric.find("li")).eq(0).addClass("mb-music-lyric-row-curr");
			// 引用到局部变量
			tmpLRC = lrcs.length && lrcs;
		}

		function _duration2time (duration) {
			duration = duration.toFixed(0);
			var m = Math.round(duration/60);
			var s = duration%60;
			return (m > 9 ? m : '0'+m) +':' + (s > 9 ? s : '0'+s);
		}

		return {
			init : function (e, meta) {
				// 初始化音乐封面
				var coverURL = meta.pic;
				var currentPlay = JPlayer.current;

				JPlayer.$hcover
	                .css("backgroundImage", "url("+(coverURL?coverURL.slice(0, coverURL.length-6)+'.jpg':"about:blank")+")")
	                .addClass("mb-disk-cover-show");

                // 初始化当前播放显示
	            JPlayer.$name.text(meta.title);
	            JPlayer.$singer_album.text(meta.artist+"《"+meta.album_name+"》");

	            // 初始化播放列表
	            var $currPlayItem = JPlayer.$list.find("li:nth-child("+ (currentPlay+1) +")");
	            $currPlayItem.find(".mb-music-list-item-singer").text(meta.artist);
	            $currPlayItem.find(".mb-music-list-item-duration").text(_duration2time(JPlayer.buffer.duration));

	            // 获取歌词文件，并解析好
	            if ( cacheLRC[currentPlay] ) {
	            	_initLRC(cacheLRC[currentPlay])
	            } else {
	            	JPlayer.parseLyric(meta, function (lrcs) {
	            		if ( lrcs && lrcs.length ) {
	            			_initLRC(cacheLRC[currentPlay] = lrcs)
	            		} else {
	            			// 歌词解析失败
	            			$lyric.text("找不到相关歌词")
	            		}
	            	});
	            }
				
			},
			setupLRC : function () {
				if (tmpLRC) {
					// console.log(tmpLRC[pointer)
					if ( JPlayer.offsetTime > tmpLRC[pointer].s ) {
						// 移除上一行样式
	                    $LRCitems.eq(pointer-1).removeClass("mb-music-lyric-row-curr");
						// removeClass(LRCitems[pointer-1], "curr")
						// 添加当前行样式
	                    $LRCitems.eq(pointer).addClass("mb-music-lyric-row-curr");
						// addClass(LRCitems[pointer], "curr")
						// 设置居中
						$lyric.css({"-webkitTransform" : 'translate3d(0px, '+ (middlePos-40*pointer++) +'px, 0px)'});
						// 结束，暂停操作
						pointer === tmpLRC.length && (tmpLRC=null);
					}
				}
			},
			resetLRC : function () {
				pointer = 1;
				// 重置歌词列表
	            $lyric.html("").text("歌词").css({
                	"-webkitTransform" : "translate3d(0px, 0px, 0px)"
                });
			}
		}
	}());

	// ============== addEventListener to JPlayer's event
	// on start a new music
	JPlayer.on("start", function () {
		// lyric status
		JPlayer.$lyric.html("").text("Loading...");
		// play list status
		JPlayer.$list
			.find("li:nth-child("+ (JPlayer.current+1) +")").addClass("mb-music-list-item-curr");
		// hide loading progress
		$("#alertLoader").dialog("hide");
		// progress reset
		JPlayer.UIprogress.max = JPlayer.UIprogressbg.max = 0|JPlayer.buffer.duration;
	})
	.on("playing", function () {

		JPlayer.UIprogress.value = JPlayer.UIprogressbg.value = JPlayer.offsetTime;
		UImeta.setupLRC();

	})
	.on("meta", UImeta.init)
	.on("replay", function () {
		// cd disk animation
		JPlayer.$hdisk.removeClass("mb-disk-pause");
		// play button status
		JPlayer.$play.addClass("mb-ctrl-playing");
	})
	.on("pause", function () {

		JPlayer.$hdisk.addClass("mb-disk-pause");
		JPlayer.$play.removeClass("mb-ctrl-playing");
		// addClass(that.ui.hdisk, "pause")

	})
	.on("stop", function () {

		// cd disk animation
		JPlayer.$hdisk.addClass("mb-disk-pause");
		JPlayer.$hcover.removeClass("mb-disk-cover-show");
		// play button status
		JPlayer.$play.removeClass("mb-ctrl-playing");
		// lyric status
		UImeta.resetLRC();
		// play list status
		JPlayer.$list.find("li:nth-child("+ (JPlayer.previous+1) +")").removeClass("mb-music-list-item-curr");
		// progress reset
		JPlayer.UIprogress.value = JPlayer.UIprogressbg.value = 0;

	})
	.on("loading", function () {

		$("#alertLoader").dialog("show");

	})
	.on("progress", function (e, dat) {

		var loaded = dat.loaded,
			total  = dat.total;

		drawLoading(loaded, total);
	})
	// ================ addEventListener to UI
	// 监听列表播放操作
	.$body.on("click", "li[data-player=playitem]", function () {
		JPlayer.play(this.dataset.index)
	})
	// 监听下一首事件
	.on("tap", "p[data-player=next]", function () { JPlayer.next() })
	// 监听上一首事件
	.on("tap", "p[data-player=prev]", function () { JPlayer.prev() })
	// 监听播放暂停事件
	.on("tap", "p[data-player=play]", function () { JPlayer.play() })

	// 监听频谱图切换
	.on("tap", "[data-player=meter]", function (e) {
		if ( JPlayer.$meter.hasClass("mb-ctrl-meter-wave") ) {
			JPlayer.$meter.removeClass("mb-ctrl-meter-wave");
			JPlayer.setMeter("frequency")
		} else {
			JPlayer.$meter.addClass("mb-ctrl-meter-wave");
			JPlayer.setMeter("wave")
		}
	})
	// 监听均衡控制开关
	.on("tap", "[data-player=eq]", function (e) {
		JPlayer.$eq.addClass("mb-ctrl-eq-on");
		$("#alertEq").dialog("show");
	});
	$("body").on("tap", "div[data-belong=alertEq]", function () {
		JPlayer.$eq.removeClass("mb-ctrl-eq-on");
	});

	// UI animation loading
	var drawLoading = function () {
		// body...
		var ctx = document.getElementById("loader").getContext('2d');
		var perc = document.getElementById("loaderPercent");
		// var len = ctx.width;
		var radius = ctx.canvas.width/2;
		// console.log(ctx)
		var PI2 = 2 * Math.PI;
		// var PI15 = 1.5 * Math.PI;
		var PI_2 = Math.PI/2;

		function _clear_ () {

			ctx.clearRect(0,0,radius,radius);
				
			ctx.beginPath();
			ctx.strokeStyle = "#afafaf";
			ctx.lineWidth = 4;
			ctx.lineCap = "round";
			ctx.arc(radius, radius, radius-4, -PI_2, 1.5 * Math.PI);
			ctx.stroke();
			perc.innerText = "0";
			// return _clear_
		}

		return function (curr, total) {
			_clear_();
			// console.log(curr, total)
			var percent = curr/total;

			ctx.beginPath();
			ctx.strokeStyle = "#c28a03";
			ctx.arc(radius, radius, radius-4, -PI_2, PI2*percent-PI_2);
			ctx.stroke();
			perc.innerText = Math.floor(percent*100);

			// if ( curr === total ) _clear_();
		}
	}();

}())
</script>
</html>