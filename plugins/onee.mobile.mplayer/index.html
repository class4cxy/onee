<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>J.Player</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="http://jdoi.net/git/onee/style/initialize.css">
    <link rel="stylesheet" href="./carousel.css">
    <link rel="stylesheet" href="./dialog.css">
    <link rel="stylesheet" href="./notify.css">
    <link rel="stylesheet" href="./alert.css">
    <link rel="stylesheet" href="./backdrop.css">
</head>
<style>
	
	/*rewrite alert.css*/
	/* .ui-alert-load{
		padding: 0;
		height: 100px;
		width: 100px;
	} */
	.ui-alert,
	.ui-alert-body{
		padding: 0;
	}

	html,body{
		height: 100%;
		width: 100%;
		font-size: 15px;
		background: #ccc url(images/bg.png) repeat;
	}
	*{
		margin: 0;
		padding: 0
	}
	em, i{
		font-style: normal;
	}
	input[type=range]{
		-webkit-appearance:none;
		background: none
	}
	input[type=range]:focus{
		outline: none;
	}
	input[type=range]::-webkit-slider-runnable-track{

	}
	input[type=range]::-moz-range-track{
		background: none;
		border:none;
	}
	input[type=range]::-webkit-slider-thumb{
		-webkit-appearance :none;
		cursor: pointer;
	}
	input[type=range]::-moz-range-thumb{
		background: none;
		cursor: pointer;
		border:none;
	}
	progress{
		-webkit-appearance: none;
	}
	progress::-webkit-progress-value {
		background-color: #c28a03
	}
	.ui-border-1px{
	    position: relative;
	}

	.ui-border-1px:after{
	    content: "";

	    display: block;
	    position: absolute;
	    top: 0;
	    left: 0;
	    right: -100%;
	    bottom: -100%;

	    -webkit-transform-origin: 0 0;
	    -webkit-transform: scale(0.5);

	    pointer-events: none;
	}
	.ease{
		-webkit-transition-property:all;
	    -webkit-transition-duration:.6s;
	    -webkit-transition-timing-function:ease-in-out;
		-moz-transition-property:all;
	    -moz-transition-duration:.6s;
	    -moz-transition-timing-function:ease-in-out;
	}
	.musicbox{
		/*height: 560px;*/
		width: 100%;
		height: 100%;
		/*margin: auto;*/
		color: #fff;
		position: relative;
		overflow: hidden;
	}

	.mb-article{
		position: relative;
		letter-spacing: -5px;
	}
	.mb-article:before{
		content: "";
		height: 100%;
		display: inline-block;
		vertical-align: middle;
		width: 0;
		overflow: hidden;
	}
	.mb-logo{
		position: absolute;
		font-size: 36px;
		font-weight: bold;
		height: 60px;
		line-height: 60px;
		text-align: center;
		width: 195px;
		text-shadow:0 0 5px rgba(0,0,0,.4);
		top: 12px;
		background-color: 
		left: 0
	}

	.mb-hack-vmiddle{
		position: relative;
		z-index: 1;
		display: inline-block;
		vertical-align: middle;
		width: 100%;
	}
	.mb-hack-blur{
		/*-webkit-filter: blur(5px);*/
	}
	.mb-disk,
	.mb-meter{
		position: absolute;
		height: 100%;
		width: 100%;
		top: 0;
		left: 0;
		z-index: 1
	}
	.mb-disk{
		position: relative;
		background: url(images/disk.png) center no-repeat;
		background-size: 100%;
		animation: rotate 15s linear infinite;
		-webkit-animation: rotate 15s linear infinite;
		-moz-animation: rotate 15s linear infinite;
		-ms-animation: rotate 15s linear infinite;
	}
	.mb-disk-pause{
		animation-play-state: paused;
		-webkit-animation-play-state: paused;
		-moz-animation-play-state: paused;
		-ms-animation-play-state: paused;
	}
	@-moz-keyframes rotate {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}
	@-webkit-keyframes rotate {
		0% {
			-webkit-transform: rotate(0deg);
		}
		100% {
			-webkit-transform: rotate(360deg);
		}
	}
	.mb-disk-cover{
		width: 93.75%;
		height: 100%;
		position: absolute;
		/*background: url('cover.jpg') center no-repeat;*/
		background-size: cover;
		border-radius: 500px;
		top: 0;
		left: 0;
		/* top: 50%;
		left: 50%; */
		/*margin: -151px 0 0 -149px;*/
		margin:-.5% 0 0 3.7%;
		opacity: 0;
		z-index: 1
	}
	.mb-disk-cover-show{
		opacity: 1
	}
	.mb-disk-axis{
		position: absolute;
		top: 50%;
		left: 50%;
		z-index: 5;
		height: 50px;
		width: 50px;
		margin: -27px 0 0 -24px;
		background-color: #0d0f0e;
		box-shadow: inset 2px 4px 5px rgba(13,15,14,.5),
					0 0 0 25px rgba(21,24,21,.7),
					0 0 0 32px rgba(21,24,21,.4);
		border-radius: 100px;
	}

	.mb-meter{
		opacity: .4;
		z-index: 2;
	}
	.mb-music{
		position: absolute;
		z-index: 5;
		top: 0;
		left: 0;
		height: 100%;
		width: 100%;
		overflow: hidden;
	}
	.mb-music-wrap{
		height: 100%
	}
	.mb-music-item{
		width: 100%;
		height: 100%;
		/*background-color: rgba(0,0,0,.5);*/
		background: url("./images/bg.png") repeat;
		letter-spacing: 0;
		position: relative;
		-webkit-overflow-scrolling: touch;
	}
	/*.mb-music-item-bg{
		position: absolute;
		z-index: 1;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: url("./images/bg.png") repeat;
	}*/
	.mb-music-empty{
		/*background-color: transparent;*/
		background: none
	}
	.mb-music-list{
		overflow: auto;
	}
	.mb-music-list-item{
		height: 60px;
		/*line-height: 50px;*/
		margin-left: 15px;
		position: relative;
		z-index: 2;
		display: -webkit-box;
		-webkit-box-align: center;
	}
	.mb-music-list-item-curr{
		color: #ffab3f
	}
	.mb-music-list-item-curr:before{
		content: "";
		width: 8px;
		height: 100%;
		position: absolute;
		display: block;
		top: 0;
		left: -15px;
		background-color: #ffab3f
	} 
	.mb-music-list-item-hack-middle{
		-webkit-box-flex:10;
	}
	.mb-music-list-item:after{
		border-bottom: 1px solid #848484;
	}
	.mb-music-list-item-active{
		background-color: rgba(35,35,35,.8);
		color: #007fd5;
	}
	.mb-music-list-item-singer{
		display: block;
		font-size: 12px;
		color: #aeaeae
	}
	.mb-music-list-item-duration{
		-webkit-box-flex:1;
	}
	.mb-ctrl{
		/*border-top: 1px solid #424242;
		background: url(images/bg.png) repeat;*/
		position: absolute;
		bottom: 0;
		left: 0;
		width: 100%;
		/*padding: 0 2%;*/
		text-align: center;
		z-index: 2;
		background: rgba(0,0,0,.2)
	}
	.mb-ctrl-progress{
		position: relative;
	}
	.mb-ctrl-progress progress,
	.mb-ctrl-progress input{
		display: block;
		width: 100%;
		position: absolute;
		height: 1px;
		z-index: 1;
	}
	.mb-ctrl-progress progress{
		border: none;
		top: 0;
		left: 0
	}
	.mb-ctrl-progress input{
		position: relative;
		z-index: 2;
	}
	.mb-ctrl-progress input::-webkit-slider-thumb{
		box-shadow: 0 0 6px rgba(255,255,255,.8);
		border-radius: 4px;
		border: none;
		background-color: #c28a03;
		height: 5px;
		width: 5px;
	}

	/* .ctrl .progress input::-moz-range-thumb{
		box-shadow: 0 0 8px rgba(255,255,255,.8);
		border-radius: 4px;
		background-color: #016eb7;
		height: 4px;
		width: 4px;
	} */
	.mb-ctrl-btn{
		/*letter-spacing: -3px;*/
		margin: 8px 0;
		display: -webkit-box;
		-webkit-box-align: center;
		-webkit-box-pack: center;
		/*text-align: center;*/
	}
	.mb-ctrl-btns{
		/*background: url(images/ctrl-map.png) no-repeat;*/
		/*background-size: 100%;*/
		/*display: inline-block;*/
		/*vertical-align: middle;*/
	}
	/* .mb-ctrl-play{
		height: 70px;
		width: 70px;
		background-position: center -73px
	}
	.mb-ctrl-next{
		height: 65px;
		width: 65px;
		background-position: center -208px
	}
	.mb-ctrl-prev{
		height: 65px;
		width: 65px;
		background-position: center -137px
	} */
	.mb-currinfo{
		padding: 8px 10px;
		line-height: 18px;
		height: 40px;
		text-align: left;
	}
	.mb-currinfo-title{
		margin-bottom: 4px
	}
	.mb-currinfo-album{
		font-size: 12px
	}
	.mb-music-lyric{
		overflow: auto;
		text-align: center;
	}
	.mb-music-lyric-wrap{
		min-height: 100%;
		display: -webkit-box;
		-webkit-box-align:center;
		-webkit-box-pack:center;
		-webkit-box-orient:vertical;
		/*position: relative;*/
	}
	.mb-music-lyric-row{
		line-height: 40px;
		height: 40px;
		font-size: 16px;
		overflow: hidden;
	}
	.mb-music-lyric-row-curr{
		color: #fff;
		font-size: 20px;
		color: #ffbb39
	}
	/* .mb-tips{
		display: -webkit-box;
		position: fixed;
		z-index: 10000;
		background-color: rgba(0,0,0,.5);
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		-webkit-box-align: center;
		-webkit-box-pack: center;
	}
	.mb-tips-wins{
		background-color: #fff;
		height: 80px;
		width: 80px;
		text-align: center;
	} */
	/* .ui-alert{
		position: relative;
	} */
	.mb-loader{
		position: relative;
		height: 100px;
		width: 100px
	}
	.mb-loader-cv{
		-webkit-transform:scale(0.5);
	}
	.mb-loader-tx{
		color: #9d9b9b;
		font-size: 20px;
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		text-align: center;
		line-height: 100px
	}
	.mb-ctrl-btns{
		display: -webkit-box;
		-webkit-box-align:center;
		-webkit-box-pack: center;
		border-radius: 50px;
		margin: 0 8px;
		border: 1px solid #d79a07
	}
	.mb-ctrl-btns-el{
		display: block;
		height: 20px;
		width: 1px;
	}
	.mb-ctrl-next .mb-ctrl-btns-el,
	.mb-ctrl-prev .mb-ctrl-btns-el{
		height: 16px;
		width: 16px;
	}
	.mb-ctrl-play .mb-ctrl-btns-el1{
		border-right: 1px solid #d79a07;
		margin-right: 9px;
	}
	.mb-ctrl-play .mb-ctrl-btns-el2{
		border-left: 1px solid #d79a07;
	}
	.mb-ctrl-next .mb-ctrl-btns-el1{
		border: solid #d79a07;
		border-width: 1px 1px 0 0;
		height: 12px;
		width: 12px;
		-webkit-transform: rotate(45deg);
	}
	.mb-ctrl-next .mb-ctrl-btns-el2{
		margin-left: 5px;
		border-left: 1px solid #d79a07;
		width: 10px
	}
	 .mb-ctrl-prev .mb-ctrl-btns-el1{
		border-right: 1px solid #d79a07;
		margin-right: 5px;
		width: 10px
	} 
	.mb-ctrl-prev .mb-ctrl-btns-el2{
		border: solid #d79a07;
		border-width: 1px 0 0 1px;
		margin-right: 5px;
		height: 12px;
		width: 12px;
		-webkit-transform: rotate(-45deg);
	}
	.mb-ctrl-play{
		height: 60px;
		width: 60px;
	}
	.mb-ctrl-playing{
		-webkit-transform: rotate(90deg);
	}
	.mb-ctrl-playing .mb-ctrl-btns-el1{
		-webkit-transform: rotate(30deg);
	}
	.mb-ctrl-playing .mb-ctrl-btns-el2{
		-webkit-transform: rotate(-30deg);
	}
	.mb-ctrl-next,
	.mb-ctrl-prev{
		height: 50px;
		width: 50px;
	}
</style>
<body>
	<div class="musicbox" data-player="body">
		<!-- <h1 class="mb-logo">J.Player</h1> -->
		<!-- <a href="javascript:;" class="tiggle" mplayer="tiggle"></a> -->
		<div class="mb-article" data-player="article">
			<div class="mb-hack-vmiddle">
				<!-- 磁碟盘 -->
				<div class="mb-disk mb-disk-pause mb-hack-blur" data-player="hdisk">
					<p class="ease mb-disk-cover mb-disk-cover-show" data-player="hcover"></p>
					<p class="mb-disk-axis"></p>
				</div>
				<!-- 频谱动画 -->
				<div class="mb-meter">
					<canvas data-player="canvas"></canvas>
				</div>
			</div>
			<div class="ui-carousel mb-music" data-enable-circle-loop="false" data-enable-auto-loop="false" data-enable-dots="true">
				<div class="ui-carousel-inner mb-music-wrap">
					<!-- 列表 -->
					<div class="ui-carousel-item mb-music-item mb-music-list">
						<!-- <p class="mb-music-item-bg"></p> -->
						<ul data-player="list" class="ui-page-content"></ul>
					</div>
					<div class="ui-carousel-item mb-music-item mb-music-empty"></div>
					<!-- 歌词 -->
					<div class="ui-carousel-item mb-music-item mb-music-lyric">
						<!-- <p class="mb-music-item-bg"></p> -->
						<ul data-player="lyric" class="ease mb-music-lyric-wrap">歌词</ul>
					</div>
				</div>
			</div>
		</div>
		<!-- 控制面板 -->
		<div class="mb-ctrl" data-player="userctrl">
			<div class="mb-currinfo">
				<p class="mb-currinfo-title" data-player="name"></p>
				<p class="mb-currinfo-album" data-player="singer_album"></p>
			</div>
			<p class="mb-ctrl-progress">
				<progress max="100" value="" data-player="progressbg"></progress>
				<input type="range" min="0" max="100" data-player="progress" value="0">
			</p>
			<div class="mb-ctrl-btn">
				<p class="mb-ctrl-btns mb-ctrl-prev" data-player="prev">
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el1"></a>
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el2"></a>
				</p>
				<p class="ease mb-ctrl-btns mb-ctrl-play" data-player="play">
					<a class="ease mb-ctrl-btns-el mb-ctrl-btns-el1"></a>
					<a class="ease mb-ctrl-btns-el mb-ctrl-btns-el2"></a>
				</p>
				<p class="mb-ctrl-btns mb-ctrl-next" data-player="next">
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el1"></a>
					<a class="mb-ctrl-btns-el mb-ctrl-btns-el2"></a>
				</p>
			</div>
			<style>
			.mb-ctrl-eq{
				position: absolute;
				bottom: 20px;
				left: 15px;
				height: 20px;
				width: 12px;
				border: #d79a07 solid;
				border-width: 0 2px
			}
			.mb-ctrl-eq-in{
				left: 5px;
				bottom: 0;
				height: 15px;
			}
			.mb-ctrl-eq-on{
				height: 15px
			}
			.mb-ctrl-eq-on .mb-ctrl-eq-in{
				height: 20px
			}
			</style>
			<div class="ease mb-ctrl-eq" data-player="eq">
				<p class="mb-ctrl-eq mb-ctrl-eq-in"></p>
			</div>
		</div>
		<!-- 解析音源loading -->
		<!-- <p mplayer="decoding" class="ease loading">decoding audio...</p> -->
	</div>
	<!-- 均衡器控件 -->
	<style>
	.mb-eq{
		width: 95%;
	}
	.mb-eq-wrap{
		width: 100%;
	}
	.mb-eq-list{
		display: -webkit-box;
		width: 540px;
		overflow: hidden;
		padding: 0 20px
	}
	.mb-eq-body{
		overflow-x: auto;
		-webkit-overflow-scrolling: touch;
	}
	.mb-eq-item{
		width: 60px;
		/*text-align: center;*/
		padding: 130px 0 10px
	}
	.mb-eq-input:hover[type=range]{
		background-color: #2c2b2a;
		box-shadow: 0 0 3px rgba(0,0,0,.6)
	}
	.mb-eq-input[type=range]{
		width: 130px;
		height: 3px;
		background-color: #7d7d7d;
		-webkit-transform: rotate(-90deg) translate(61px,-35px);
	}/* 
	.article .eqctrl input[type=range]::-webkit-slider-runnable-track{
	}
	.article .eqctrl input[type=range]::-moz-range-track{
		background-color: #282828;
		width: 2px;
		box-shadow: 1px 0 1px #040506
	} */
	.mb-eq-input[type=range]::-webkit-slider-thumb{
		box-shadow:0 0 0 5px rgba(183, 131, 6, .4);
		border-radius: 10px;
		background-color: rgba(215,154,7,.7);
		border: none;
		height: 17px;
		width: 17px;
	}
	</style>
	<div id="alertEq" class="ui-dialog mb-eq" data-dismiss="dialog" data-effect="from-above" role="alert-dialog" data-backdrop="static">
        <div class="js-dialog-content ui-alert mb-eq-wrap">
            <div class="ui-alert-body mb-eq-body" role="note" id="eqScroll">
            	<div class="content mb-eq-list" data-player="eqlist"></div>
            </div>
        </div>
    </div>
	<!--notify-->
    <div id="notify" data-backdrop="false" data-expires="2000" data-effect="from-top" class="ui-dialog ui-notify" role="notify">
        <!-- <i class="icon icon-warning"></i> -->
        <span class="content"></span>
    </div>
    <!--notify-->
    <div id="alertLoader" class="ui-dialog" data-effect="from-above" role="alert-dialog" data-backdrop="static">
        <div class="js-dialog-content ui-alert mb-loader">
            <div class="ui-alert-body" role="note">
            	<div class="content">
            		<canvas class="mb-loader-cv" id="loader" height="100" width="100"></canvas>
            		<p class="mb-loader-tx" id="loaderPercent">0</p>
            	</div>
            </div>
        </div>
    </div>
</body>
<!-- <script src="http://jdoi.net/git/onee/Lodash/lodash.min.js"></script>
<script src="http://jdoi.net/git/onee/onee.js"></script> -->
<!-- <script src="/onee/Lodash/lodash.min.js"></script>
<script src="/onee/onee.js"></script> -->
<script>
	// window.onerror = function (e) {alert(JSON.stringify(arguments))}
</script>
<script src="http://jdoi.net/git/onee/Lodash/lodash.min.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/zepto.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/event.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/touch.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/ajax.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/data.js"></script>
<script src="http://jdoi.net/git/onee/Zepto/transition.js"></script>
<script src="http://jdoi.net/git/onee/Tween/RequestAnimationFrame.js"></script>
<script src="./index.js" type="text/javascript"></script>
<script src="./carousel.js" type="text/javascript"></script>
<script src="./dialog.js" type="text/javascript"></script>
<!-- <script src="./iscroll.js" type="text/javascript"></script> -->
<script type="text/javascript">
(function () {

	var map = _.map;
	var TPL_ITEM = '<li data-player="playitem" class="ui-border-1px mb-music-list-item" data-index="{index}" data-name="{name}" data-url="{url}">\
						<div class="mb-music-list-item-hack-middle">\
						<i>{name}</i>\
						<i class="mb-music-list-item-singer"></i>\
						</div>\
						<p class="mb-music-list-item-duration"></p>\
					</li>',
		TPL_EQITEM = '<p class="mb-eq-item"><input data-freq="{freq}" class="mb-eq-input" type="range" min="-30" max="30" value="{gain}" onwheel="1"><span>{key}</span></p>';;

	var complieHTML = (function () {
		var rtpl = /\{(.*?)\}/g;
		return function (tpl, dat, index) {
			return tpl.replace(rtpl, function (a, b) {
	    		if (b === "index") return index;
	    		return dat[b];
	    	})
		}
	}());

		// init ui
	$(".ui-carousel").carousel(1);

	JPlayer.$article.css("height", window.innerHeight - JPlayer.UIuserctrl.clientHeight);
	JPlayer.$hdisk.parent().css("height", window.innerWidth * .9375);
	JPlayer.UIcanvas.height = window.innerWidth * .9375;
	JPlayer.UIcanvas.width = window.innerWidth;
	
	$('.mb-ctrl, .js-backdrop').on('touchmove', function(e){
        e.preventDefault();
    });

    // Handle the start of interactions
    $(document).on('touchstart', '.mb-music-item', function(e){
        var page = e.currentTarget;
        var startTopScroll = page.scrollTop;
        if(startTopScroll <= 0)
            page.scrollTop = 1;

        if(startTopScroll + page.offsetHeight >= page.scrollHeight)
            page.scrollTop = page.scrollHeight - page.offsetHeight - 1;

    }).on('touchmove', '.mb-music-item', function(e){
        var page = e.currentTarget;
        // TODO cache element select
        var content = page.querySelector('.ui-page-content');
        // Offset value have include content and border
        if( !content || content.offsetHeight <= parseInt(getComputedStyle(page).height) ){
            // your element have overflow
            return e.preventDefault();
        }
    })

	// build play list
	JPlayer.$list.html(map(JPlayer.cache = [
		{ name : "福尔摩斯", url : "./sources/fuermosi.mp3", singer : "萧敬腾" },
		{ name : "与我常在", url : "./sources/yuwochangzai.mp3", singer : "陈奕迅" },
		{ name : "可以了", url : "./sources/keyile.mp3", singer : "陈奕迅" },
		{ name : "3 Things", url : "./sources/3Things.mp3", singer : "Jason Mraz" },
		{ name : "北海", url : "./sources/beihai.mp3", singer : "永动机" }
	], function (source, k) {
    	return complieHTML(TPL_ITEM, source, k)
    }).join(''));

	var uiEq = {
		"f31" : "31hz",
		"f62" : "62hz",
		"f125" : "125hz",
		"f250" : "250hz",
		"f1000" : "1khz",
		"f2000" : "2khz",
		"f4000" : "4khz",
		"f8000" : "8khz",
		"f16000" : "16khz"
	};

    JPlayer.$eqlist.html(map(JPlayer.EQ, function (eq, k) {
    	return complieHTML(TPL_EQITEM, {
    		key : uiEq[k],
    		gain : eq,
    		freq : k
    	})
    }).join('')).on("input", function (e) {
    	var element = e.target;
    	JPlayer.eq(element.dataset.freq, element.value)
    });

	// ============== addEventListener to JPlayer's event
	// on start a new music
	JPlayer.on("start", function () {
		JPlayer.$hdisk.removeClass("mb-disk-pause");
		JPlayer.$play.addClass("mb-ctrl-playing");
		JPlayer.$lyric.html("").text("Loading...");
		JPlayer.$list
			.find(".mb-music-list-item").removeClass("mb-music-list-item-curr")
			.eq(JPlayer.current).addClass("mb-music-list-item-curr");
		JPlayer.UIprogress.max = JPlayer.UIprogressbg.max = 0|JPlayer.buffer.duration;
	})
	.on("playing", function () {

		JPlayer.UIprogress.value = JPlayer.UIprogressbg.value = JPlayer.offsetTime;
		// removeClass(that.ui.hdisk, "pause")

	})
	.on("pause", function () {

		JPlayer.$hdisk.addClass("mb-disk-pause");
		JPlayer.$play.removeClass("mb-ctrl-playing");
		// addClass(that.ui.hdisk, "pause")

	})
	.on("stop", function () {

		JPlayer.$hdisk.addClass("mb-disk-pause");
		JPlayer.$hcover.removeClass("mb-disk-cover-show");
		JPlayer.$play.removeClass("mb-ctrl-playing");
		JPlayer.$lyric.html("").text("歌词");
		JPlayer.UIprogress.value = JPlayer.UIprogressbg.value = 0

	})
	.on("loading", function () {

		$("#alertLoader").dialog("show");

	})
	.on("progress", function (e, dat) {

		var loaded = dat.loaded,
			total  = dat.total;

		if ( loaded === total ) {
			$("#alertLoader").dialog("hide");
		}

		drawLoading(loaded, total);
	})
	// ================ addEventListener to UI
	// 监听列表播放操作
	.$body.on("click", "li[data-player=playitem]", function () {
		JPlayer.play(this.dataset.index)
	})
	// 监听下一首事件
	.on("tap", "p[data-player=next]", function () { JPlayer.next() })
	// 监听上一首事件
	.on("tap", "p[data-player=prev]", function () { JPlayer.prev() })
	// 监听播放暂停事件
	.on("tap", "p[data-player=play]", function () { JPlayer.play() })

	.on("tap", "[data-player=eq]", function (e) {
		$(this).addClass("mb-ctrl-eq-on");
		$("#alertEq").dialog("show");
	});

	// UI animation loading
	var drawLoading = function () {
		// body...
		var ctx = document.getElementById("loader").getContext('2d');
		var perc = document.getElementById("loaderPercent");
		// var len = ctx.width;
		var radius = ctx.canvas.width/2;
		// console.log(ctx)
		var PI2 = 2 * Math.PI;
		// var PI15 = 1.5 * Math.PI;
		var PI_2 = Math.PI/2;

		var _clear_ = function _clear_ () {

			ctx.clearRect(0,0,radius,radius);
				
			ctx.beginPath();
			ctx.strokeStyle = "#afafaf";
			ctx.lineWidth = 4;
			ctx.lineCap = "round";
			ctx.arc(radius, radius, radius-4, -PI_2, 1.5 * Math.PI);
			ctx.stroke();
			perc.innerText = "0";
			return _clear_
		}();

		return function (curr, total) {
			// console.log(curr, total)
			var percent = curr/total;

			ctx.beginPath();
			ctx.strokeStyle = "#c28a03";
			ctx.arc(radius, radius, radius-4, -PI_2, PI2*percent-PI_2);
			ctx.stroke();
			perc.innerText = Math.floor(percent*100);

			if ( curr === total ) _clear_();
		}
	}();

	// UI lyric
	(function(){

		var tmpLRC;
		// 当前歌词索引
		var pointer = 1;
		var $lyric = JPlayer.$lyric;
		var middlePos = $lyric.parent().height()/2 - 20;
		// var UIlyric = JPlayer.UIlyric;
		// 歌词节点列表
		var $LRCitems;
		JPlayer.on("meta", function (e, meta) {
			var coverURL = meta.pic;
			JPlayer.$hcover
                .css("backgroundImage", "url("+(coverURL?coverURL.slice(0, coverURL.length-6)+'.jpg':"about:blank")+")")
                .addClass("mb-disk-cover-show");

            JPlayer.$name.text(meta.title);
            JPlayer.$singer_album.text(meta.artist+"《"+meta.album_name+"》");

            // 
            var $currPlayItem = JPlayer.$list.find("li").eq(JPlayer.current);
            $currPlayItem.find(".mb-music-list-item-singer").text(meta.artist);
            $currPlayItem.find(".mb-music-list-item-duration").text(duration2time(JPlayer.buffer.duration));
			// 获取歌词文件，并解析好
			JPlayer.parseLyric(meta, function (lrcs) {
				// build lyric html
                $lyric
                    .html($.map(lrcs, function(item) {
                        return '<li class="mb-music-lyric-row">'+item.tx+'</li>';
                    }).join(''))
                    .css({
                    	"-webkitTransform" : "translate3d(0px, "+middlePos+"px, 0px)"
                    });
                // 引用歌词节点，初始化歌词节点
				($LRCitems = $lyric.find("li")).eq(0).addClass("mb-music-lyric-row-curr");
				// 引用到局部变量
				tmpLRC = lrcs.length && lrcs;

			});
		});
		function duration2time (duration) {
			duration = duration.toFixed(0);
			var m = Math.round(duration/60);
			var s = duration%60;
			return (m > 9 ? m : '0'+m) +':' + (s > 9 ? s : '0'+s);
		}

		JPlayer.on("playing", function (e, audio) {
			if (tmpLRC) {
				// console.log(tmpLRC[pointer)
				if ( audio.currentTime > tmpLRC[pointer].s ) {
					// 移除上一行样式
                    $LRCitems.eq(pointer-1).removeClass("mb-music-lyric-row-curr");
					// removeClass(LRCitems[pointer-1], "curr")
					// 添加当前行样式
                    $LRCitems.eq(pointer).addClass("mb-music-lyric-row-curr");
					// addClass(LRCitems[pointer], "curr")
					// 设置居中
					$lyric.css({"-webkitTransform" : 'translate3d(0px, '+ (middlePos-40*pointer++) +'px, 0px)'});
					// $lyric.css("top", middlePos-40*pointer++);
                    // UIlyric.style.top = (111-40*pointer++)+'px';
					// 结束操作
					pointer === tmpLRC.length && (tmpLRC = null);
				}
			}
		});

	}());
}())
</script>
</html>